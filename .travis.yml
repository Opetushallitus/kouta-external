sudo: required
dist: xenial
language: scala
scala:
  - 2.12.2
jdk:
  - openjdk11
services:
  - docker
  - postgresql

addons:
  postgresql: "11"
  apt:
    packages:
      - postgresql-11
      - postgresql-client-11

cache:
  directories:
  - $HOME/.m2

env:
  global:
    - PGPORT=5433
    # AWS_ACCESS_KEY_ID
    - secure: "GyfuAyaczjtNLZEWiR6uAC1JH6ssVaL7zJfEPyYLbudDTBgUR3qXQ33x65pJiJPsCeHtZb3BzWUfNKlVFyPKDtcvfVfs70Pf9JVHsDtrIEapo1rTOZ8J/eybxyeHvTMyH0+BgO+CZd3HVxU+2K8rWDN1O1bscogpc2CfShhQ8sfkuT3FRBnzr+CuPpa/dORNa+auA1a+2WEqxMu7cP5+p8pJ8YtKjjHefKkhT2SXgPBUWJAISfst0WK4+xBWPy4XvKOrlhsmDrBPRhW8v+NlqDLat48oEJGChAo72Rgd3SwbWhFTRyYvYzBYOTNkZ9btPDe9WecUHgy7equ6zbJ4GYlMbFyBabg0RhTbIxuo1fHrWZ4V6LIHqcUIdsi0MHbZMQi9CFgUj+DbhSEci6fC75bzz62A8KWNjDCHlBP369D2XWPKDnKxzCe9TmfaG0LPq+DVqVGs+7849a+aucRgmfiiGLhlf6X6tNHKXyI8zEYk5+DS6AbE5lLHatrYunb1VinCnzT1F2pXTKsCWeZShzyy7ciWDhlUo3YxcNILkWdMAhRxBlwEQ5bKPcJnvAtSy4K0sGwDgwPWgU1FBgSzGV4IUA5YmAdRzgp6GvNB93baEGkHYVNLg5G+QX39QIX5zTdc+paf59c3mD+AdSMW5JiSRV0VlEv7sMnn78syvM4="
    # AWS_SECRET_ACCESS_KEY
    - secure: "Iyj8fI140zEPS9+KvcacRX4w+5XZ0ZhoN8kV/4U33VeSTeukoxdYjrFnEjrhVbjuF3ZCNeAYIEerJ7XX6eTnDTzGgsw8EqqUOcxTk8+UGf24nmk+1qKwN2yKgLjztg9wYHb8aIvW0JCvXD0Imn9vvjufMCXGVVQM20BjgtEo7i48CnLIo2ei8nWMWc0NpbKfrFYk0HtEp98dkKhatqEY6EngHjrjvZb3P/etcxG87UGCyRM1HKa9obC+MncTdPw63YlqEWCLW1k4IXacT7x2zqiPBEFx/i2I5db9bXJDz8OJZdvT4PMOWe0EwWoRxl4NWyHyAfxGFM+o+dQkNNr0xR4AZbuib7Hvj7K9x2xJ/q/M0kqrjBfQB8GjDmibnB8qsygQ0MzaGeCixceIKwLSrMqHlI1stRjBYUC4vSv3jx2zDgK5iS/baOvT9iaDNQwe5Gfafd6FSzIiQHt8au5iKd71i5D4yXCRpCkQ9L60kzTPzpht56BumXnhxtiQIW7nFRTLTcMC80SN4WqYT0rx15WllELKL7GokI+N2nd+f5KaXvqKxc+bV0rDRzCtCyBjcRsf2UmRJ6X6/8eWGbwSjuSLtBbBfStRyyxZsGwHx8VIYNe3ihewIN7UItx+MFwF0N4Du8X70WhG3bnqNn32zd70PocbCzKnwFBH+D46P4M="

before_install:
  # https://github.com/travis-ci/travis-ci/issues/9624
  - sudo sed -i -e '/local.*peer/s/postgres/all/' -e 's/peer\|md5/trust/g' /etc/postgresql/*/main/pg_hba.conf
  - sudo systemctl restart postgresql@11-main
  - sleep 1

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
  - export ARTIFACT_NAME="kouta-external"

before_script:
  - DB_NAME=koutaexternal
  - psql -c "create database $DB_NAME WITH ENCODING 'UTF8' LC_COLLATE='C' LC_CTYPE='C' TEMPLATE template0;" -U postgres
  - psql -d $DB_NAME -f postgresql/init_it_postgresql.sql

script:
  - mvn install --batch-mode -DargLine="-Dkouta-external.test-postgres-port=${PGPORT}"

  - mv target/kouta-external-*-jar-with-dependencies.jar $DOCKER_BUILD_DIR/artifact/${ARTIFACT_NAME}.jar
  - cp -vr src/main/resources/* $DOCKER_BUILD_DIR/config/

  - export BASE_IMAGE="baseimage-fatjar-openjdk11:master"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-fatjar.sh $ARTIFACT_NAME

deploy:
  - provider: script
    script:
      ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
    on:
      all_branches: true
